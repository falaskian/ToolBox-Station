/*
* Everything else goes here. (implants, barriers, etc)
*/


/*
* Implants
*/



/*
* Dogtag
*/

/obj/item/card/id/perseus
	name = "Perseus Dog tags"
	icon_state = "dogtags"
	icon = 'icons/oldschool/perseus.dmi'
	var/list/can_be_engraved_by = list(/obj/item/kitchen/knife,
									/obj/item/stun_knife)

/obj/item/card/id/perseus/examine()
	. = ..()
	if(check_perseus(usr))
		. += "<span class='notice'>It looks like you could easily scratch in a new identification with a knife.</span>"

/obj/item/card/id/perseus/attackby(obj/item/W as obj, mob/user as mob)
	var/datum/extra_role/perseus/P = check_perseus(user)
	if(P)
		var/obj/item/engrave_tool
		for(var/t in can_be_engraved_by)
			if(istype(W,t))
				engrave_tool = W
				break
		if(engrave_tool)
			if(registered_name || assignment || registered_account)
				var/scratchoff = alert(user,"Would you like to scratch the name off this [initial(name)]?",name,"Scratch","No")
				if(scratchoff != "Clear")
					return
				registered_name = null
				assignment = null
				registered_account = null
				name = initial(name)
				to_chat(user, "<span class='notice'>You scratch the [src] clean with the [engrave_tool] of any idenfication.</span>")
			else
				var/scratchon = alert(user,"Would you like to engrave your own identification in to this [src]?",name,"Yes","No")
				if(scratchon == "Yes" && P)
					registered_name = P.perseus_name()
					assignment = "Perseus Security [P.iscommander ? "Commander" : "Enforcer"]"
					update_label()
					to_chat(user, "<span class='notice'>You engrave your Perseus identity into the [initial(name)] with the [engrave_tool].</span>")
					if(istype(user,/mob/living/carbon/human))
						var/mob/living/carbon/human/H = user
						if(H.account_id)
							to_chat(H, "<span class='notice'>Your account ID is [H.account_id].</span>")
							set_new_account(H)
			return
	return ..()
/*
* SOP Book
*/

/obj/item/book/manual/sop
	name = "Perseus Standing Operations Procedures"
	desc = "A book detailing the standard rules and procedures for Perseus."
	icon_state = "bookSoP"
	icon = 'icons/oldschool/perseus.dmi'
	author = "Perseus CEO; Theodore Blackwell"
	title = "Perseus Standing Operations Procedures Manual"

	dat = {"<html>
				<head>
				<style>
				h1 {font-size: 18px; margin: 15px 0px 5px;}
				h2 {font-size: 15px; margin: 15px 0px 5px;}
				li {margin: 2px 0px 2px 15px;}
				ul {list-style: none; margin: 5px; padding: 0px;}
				ol {margin: 5px; padding: 0px 15px;}
				</style>
				</head>
				<body>

				<H3>PERSEUS STANDING OPERATIONS PROCEDURE</H3>
				<I>as created by Perseus CEO; Theodore Blackwell<BR><BR>
				These are the active Perseus Protocols, and should be followed as closely as possible on pain of termination.

				<ol>
					<li><a href='#1'>When to enter the station</a></li>
					<li><a href='#2'>Arrests and Evidence</a><br>
					<a href='#2a'>2a. Prison Procedure</a></li>
					<li><a href='#3'>Priorities</a></li>
					<li><a href='#4'>Backup</a></li>
					<li><a href='#5'>Downtime</a></li>
					<li><a href='#6'>Xenomorphs</a></li>
					<li><a href='#7'>Interactions</a></li>
					<li><a href='#8'>Impersonations</a></li>
					<li><a href='#9'>Caution on Calls</a></li>
					<li><a href='#10'>Levels of force</a></li>
					<li><a href='#11'>Hivemind</a></li>
				</ol>

				<a name='1'><H4>When to enter the station</H4>
				1. Perseus Personnel should make contact with the heads of the Celestial Complex in question as soon as possible, and make Perseus services available. Perseus Personnel should NOT move to board a Celestial Complex without a request for assistance from an acting Head of Staff via radio communication, or if none are available anyone on the Complex's local security scans (radio channel) If Security doesn't respond, send a request to the AI. If no one responds, use your judgment. Enforcers should board only in situations which pose a serious threat to life and/or station.

				<a name='2'><H4>Arrests and Evidence</H4>
				2. Suspects should not be imprisoned on the Mycenae without the explicit permission of the highest Security authority present on the station. If no security is present, available, or is otherwise disabled, the Enforcer should use their best judgment. Mycenae imprisonment is appropriate only for those proven guilty of a Capital Crime under Space Law. Suspects guilty of lesser crimes should be held by station security. Before you prison a suspect, gather the evidence that proves they are a traitor, syndicate, Etc.

				<a name='2a'><H4>Prison procedure:</H4>
				2a. Buckle a handcuffed prisoner to the shuttle chair. Once docked with the Mycenae, flash/stun them and take them to the prisoner gear closets. Strip them of their gear at either of the two prisoner gear closets. Outfit them in prison jumpsuits and take them to their cell. Once inside, flash/stun them and then leave. Do be polite through the proceeding. If other personnel bring you a prisoner, have them drop the evidence in the shuttle and cuff the prisoner to one of the chairs. Then tell them to leave the shuttle and call the shuttle to you. Then, once ascertaining that the shuttle is clear of all but the prisoner, get aboard and follow the above steps.

				<a name='3'><H4>Priorities</H4>
				3. Our first priority is the guarding of our ship. Keep the ship safe before protecting the client.

				<a name='4'><H4>Backup</H4>
				4. Perseus Personnel should NEVER (at risk of life and limb) enter a Celestial Complex or hostile situation outside of the ship ALONE. Always work together in groups or have nearby back up that can assist you. Security can sometimes fulfill this role, but remember that they cannot be fully trusted. (Use say:":a")

				<a name='5'><H4>Downtime</H4>
				5. During downtime or awaiting request to enter a Celestial Complex, Perseus Personnel should remain on the ship, OR may participate in live fire exercises in approved training areas.

				<a name='6'><H4>Xenomorphs</H4>
				6. Xenomorphs should always be hunted down and destroyed. This goes above the wishes of the client. �Xenomorph� is a proper noun that refers to a specific alien species, despite its root words being appropriately interpreted as 'Alien form.' The following species are not denoted by the term �Xenomorph�: Slimes, Carp, or Hivebots. In the event that Xenomorphs are discovered and not contained within the secure holding facility in Xenobiology, Perseus will board with the intent to destroy them.

				<a name='7'><H4>Interactions</H4>
				7. All interactions between Perseus Personnel and other all personnel, even prisoners, should be calm, professional, and considerate. Directions from Heads of Staff loyal to Nanotrasen should be followed, except where there are grounds to believe the order is dangerous, inappropriate, would interfere with your assigned mission, or would otherwise conflict with the SOP.

				<a name='8'><H4>Impersonations</H4>
				8. Never wear the dog tags of another enforcer, impersonate, or otherwise take any action that could confuse the identification of yourself or any other enforcer.

				<a name='9'><H4>Caution on Calls</H4>
				9. Beware of false calls. When a head sends a prisoner to the station have them buckle them to the chair and send the shuttle. Do not allow any personnel other than prisoners and Perseus units on the shuttle.

				<a name='10'><H4>Levels of force</H4>
				10. For the level of force allowed for a close range engagement ALWAYS consult the SIX levels of combativeness: REMEMBER. YOU ARE ALLOWED TO JUMP ONE LEVEL OF FORCE HIGHER THAN THE SUBJECT, IF NECESSARY.

				<li>Level 1: Compliant (Cooperative). The subject responds and complies with verbal commands. Close combat techniques do not apply.</li>
				<li>Level 2: Resistant (Passive). The subject resists verbal commands but complies immediately with any contact controls. Close combat techniques do not apply.</li>
				<li>Level 3: Resistant (Active). The subject initially demonstrates physical resistance. Use compliance techniques to control the situation. Level three incorporates close combat techniques to physically force a subject to comply. Techniques include: Disarm intent, Stun Baton, Flash, Flashbang, Restraints and more verbal commands.</li>
				<li>Level 4: Assaultive (Bodily Harm). The subject may physically attack, but does not use a weapon or show lethal intent. Use defensive tactics to neutralize the threat. Defensive tactics include using your P90 or flash, disarm, and any other non-lethal option.</li>
				<li>Level 5: Assaultive (Disabling). The subject possesses a stunning weapon and shows clear intent to disable and harm the Enforcer. Defensive tactics include using your P90 or flash, disarm, and any other non-lethal option. The subject should be detained and handed to station security if they are available, responsive, or cooperative.</li>
				<li>Level 6: Assaultive (Lethal Force). The subject usually has a weapon and will either kill or injure someone if he/she is not stopped immediately and brought under control. The subject must be controlled by any means necessary with or without a firearm.</li>
				<br><br>
				Enforcers are expected to constantly evaluate and are encouraged to respond to the level of force the Subject is using at any given moment in accordance with the Levels of Force continuum. The ultimate purpose of this use of force policy is to encourage Enforcers to use the least amount of force they reasonably believe will accomplish their objectives. If an Enforcer applies an unreasonable amount of force in a given situation, he or she may be subject to disciplinary action.
				Enforcers are not obligated to follow this use of force policy during an active break in; lethal force is authorized against any not restrained person who attempts to break into or out of a Perseus vessel. Be careful with regard to identity and impersonations.
				Use of lethal force is authorized against an unrestrained detainee if an Enforcer reasonably believes a crisis situation, such as complete loss of control of the interior of his vessel, is imminent and or that the detainee intends to seize an immediately present and clearly describable opportunity to escape and cause further death, great bodily harm, or serious property damage of an interest or patron of Perseus.
				Enforcers are invited to warn subjects when lethal force is considered an option. They are not obligated to, particularly when it would be tactically unwise.
				Upon completion of a mission, Enforcers are expected to immediately depart the celestial complex.

				<a name='10'><H4>Hivemind</H4>
				11. Information contained in the Perseus Hive-mind is not to be shared with anyone who did not participate in that session.{This is an OOC rule as well as an IC rule}.

				<p>Good luck and stay safe.



				</body>
				</html>
				"}
/*
removed sections which read.
<H4>Hivemind</H4>
11. Information contained in Hive-mind, Perseus Chat, and the Commander Chat is not to be shared with anyone not in those chats without the express permission of the Head Perseus Commander.


<H4>Skype</H4>
12. Participating, when possible, in the Perseus Skype Chat and commenting on new enforcer applications (even if only on application content) is an expectation of continued Perseus membership.
*/


/*
* Oxygen Tank
*/

/obj/item/tank/perseus
	name = "PercTech branded emergency pluoxium tank"
	desc = "PercTech brand emergency pluoxium tank. Contains pluoxium, Only a 3 kpa output is required."
	icon_state = "perctank"
	icon = 'icons/oldschool/perseus.dmi'
	flags_1 = CONDUCT_1
	volume = 3
	w_class = WEIGHT_CLASS_SMALL
	slot_flags = ITEM_SLOT_BELT
	item_state = "emergency"
	force = 4
	distribute_pressure = 3 //pluoxium

	populate_gas()
		air_contents.set_moles(/datum/gas/pluoxium, (10*ONE_ATMOSPHERE)*volume/(R_IDEAL_GAS_EQUATION*T20C))

/*
* Jet harness
*/

/obj/item/tank/jetpack/oxygen/perctech
	name = "PercTech jet harness (oxygen)"
	desc = "A lightweight tactical harness, used by those who don't want to be weighed down by traditional jetpacks and adapted by Perseus Quartermasters for PMC use."
	icon_state = "perc-jet"
	item_state = "perc-jet"
	icon = 'icons/oldschool/perseus.dmi'
	alternate_worn_icon = 'icons/oldschool/perseus_worn.dmi'
	volume = 35
	throw_range = 7
	w_class = 3

/*
* Stimpack
*/

/obj/item/stimpack
	desc = "A single use rapid injection unit containing various chemicals."
	name = "stim tank"
	icon = 'icons/oldschool/perseus.dmi'
	icon_state = "stimpack_1"
	slot_flags = SLOT_BELT
	w_class = 1.0

	New()
		..()

		var/datum/reagents/R = new/datum/reagents(20)
		reagents = R
		R.my_atom = src

	attack(mob/M as mob, mob/user as mob)
		if (!(istype(M, /mob)))
			return
		if (reagents.total_volume)
			for(var/mob/O in viewers(M, null))
				O.show_message("\blue [M] has been stabbed with [src] by [user].", 1)
			if(M.reagents) reagents.trans_to(M, reagents.total_volume)
			icon_state = "stimpack_0"
			desc += " This one is used."
		return

	perseus/
		name = "PercTech Stimpack"
		desc = "A small disposable PercTech stimpack auto-injector, for all your basic emergency medical needs."

		New()
			..()
			reagents.add_reagent(/datum/reagent/medicine/synaptizine, 5)
			reagents.add_reagent(/datum/reagent/medicine/omnizine, 5)
			reagents.add_reagent(/datum/reagent/medicine/ephedrine, 5)

/*
* Stimpack Tank
*/

/obj/structure/stimtank/perseus
	name = "Perseus Stimtank"
	desc = "Refills your stimpacks"
	icon_state = "stimtank"
	icon = 'icons/oldschool/perseus.dmi'
	desc = "A refill tank for standard stimpacks."
	density = 1
	anchored = 1

	attackby(obj/item/W as obj, mob/user as mob)
		if(istype(W, /obj/item/stimpack) && (!W.reagents.total_volume))
			var/obj/item/stimpack/S = W
			S.reagents.add_reagent(/datum/reagent/medicine/synaptizine, 5)
			S.reagents.add_reagent(/datum/reagent/medicine/omnizine, 5)
			S.reagents.add_reagent(/datum/reagent/medicine/ephedrine, 5)
			to_chat(user, "\blue You refill the stimpack!")
			playsound(src, 'sound/effects/refill.ogg', 50, 0, null)
			W.icon_state = "stimpack_1"
			W.desc = "A small disposable PercTech stimpack auto-injector, for all your basic emergency medical needs."
			return
		else
			return ..()


/*
* Emergency Case
*/

/obj/structure/displaycase/perseus
	name = "EMERGENCY ONLY Case"
	icon_state = "pglassbox1"
	icon = 'icons/oldschool/perseus.dmi'
	start_showpiece_type = /obj/item/gun/ballistic/fiveseven
	density = 0
	var/destroyed = 0

	update_icon()
		icon_state = "pglassbox[destroyed ? "b" : ""][showpiece ? "1" : "0"]"

/*
* PDA
*/
/datum/toolbox_asset/perseuspdaicons
	assets = list(
		"pda_perseus_bd.png" = "icons/oldschool/pngs/pda_perseus_bd.png",
		"pda_perseus_i.png" = "icons/oldschool/pngs/pda_perseus_i.png",
		"pda_perseus_c.png" = "icons/oldschool/pngs/pda_perseus_c.png")

/obj/item/pda/perseus
	name = "Perseus PDA"
	default_cartridge = /obj/item/cartridge/perseus
	icon = 'icons/oldschool/perseus.dmi'
	icon_state = "pda-perc"
	toff = TRUE
	var/perseus_color = "#003399"

/obj/item/pda/perseus/equipped(mob/user, slot)
	. = ..()
	if(equipped && perseus_color)
		background_color = perseus_color
		perseus_color = null

/obj/item/pda/perseus/afterattack(atom/target, mob/living/user, flag, params)
	if(istype(target, /obj/item/electronics/airlock))
		var/obj/item/electronics/airlock/A = target
		var/perseusmodeon = 0
		if(!(88 in A.access_list_numbers))
			A.access_list_numbers += 88
			perseusmodeon = 1
		else
			A.access_list_numbers -= 88
		to_chat(user,"<span class='notice'>[perseusmodeon ? "You upgrade the [A] to include Perseus accesses." : "You hide Perseus accesses on the [A]."]</span>")
		playsound(loc, 'sound/items/timer.ogg', 50, 1)
		return
	. = ..()

/obj/item/cartridge/perseus
	name = "\improper Perseus Cartridge"
	icon = 'icons/oldschool/perseus.dmi'
	icon_state = "cart-perc"
	access = CART_SECURITY | CART_MEDICAL | CART_MANIFEST | CART_CUSTOMMENU
	bot_access_flags = SEC_BOT
	return_modes = list(4,5,6)

/obj/item/cartridge/perseus/get_custom_menu(mob/living/carbon/user)
	if(!check_perseus(user))
		return
	var/dat = "<h4>PercTech</h4>"
	dat += "<ul>"
	dat += "<li><a href='byond://?src=\ref[src];choice=61;custommenu=1'><img src=pda_perseus_bd.png> Blast Door Status</A></li>"
	dat += "<li><a href='byond://?src=\ref[src];choice=62;custommenu=1'><img src=pda_perseus_i.png> Implant Status</A></li>"
	var/obj/machinery/computer/shuttle/perseus_shuttle/P = locate() in world
	if(P)
		dat += "<li><a href='byond://?src=\ref[src];choice=Toggle Prison Shuttle;custommenu=1'><img src=pda_perseus_c.png></img> Toggle Prison Shuttle Lock - [P.locked ? "<b>Locked</b>" : "<b>Unlocked</b>"]</A></li>"
	dat += "</ul>"
	return dat

/obj/item/cartridge/perseus/customreaction(href_list,mob/living/carbon/user)
	if(!istype(user,/mob/living/carbon))
		return
	if(!check_perseus(user))
		var/datum/effect_system/spark_spread/S = new(get_turf(src))
		S.set_up(3, 0, get_turf(src))
		S.start()
		to_chat(user, "<div class='warning'>The [src] shocks you.</div>")
		user.AdjustKnockdown(40)
		return
	if(host_pda)
		var/thechoice = href_list["choice"]
		var/thechoicenum = text2num(thechoice)
		if(thechoice == "Toggle Prison Shuttle")
			var/lockedstatus = -1
			for(var/obj/machinery/computer/shuttle/perseus_shuttle/P in world)
				if(lockedstatus == -1)
					lockedstatus = P.locked
				P.locked = !lockedstatus
		else if(thechoicenum && isnum(thechoicenum))
			host_pda.mode = thechoicenum
		host_pda.attack_self(user)

/obj/item/cartridge/perseus/generate_menu()
	if((host_pda) && (host_pda.mode in list(61,62)) && (check_perseus(usr)))
		switch(host_pda.mode)
			if(61)
				menu = ""
				var/blastdoors = 1
				for(var/obj/machinery/door/poddoor/M in world)
					if(M.id == "prisonship")
						if(M.density)
							blastdoors = 1
						else
							blastdoors = 0
						break
				menu += "<i>Blast doors are: [blastdoors ? "Closed" : "Opened"]</i>"
			if(62)
				menu = "<h3><font color=\"#232D45\"> Perseus Personnel Tracker </font></h3><br>"
				var/list/commanders = list()
				var/list/enforcers = list()
				for(var/datum/extra_role/perseus/P in perseus_datums)
					if(P.affecting && istype(P.affecting.current,/mob/living))
						if(P.iscommander)
							commanders += P
						else
							enforcers += P
				var/implantnumber = 0
				for(var/datum/extra_role/perseus/P in commanders)
					var/mob/living/L = P.affecting.current
					var/turf/T = get_turf(L)
					var/area/A = get_area(T)
					if(!A || !T)
						continue
					implantnumber++
					menu += "Implant <b>[implantnumber]</b>: <br>"
					menu += "Area: <b>[A.name]</b><br>"
					menu += "Coordinates: <b>(X: [T.x] Y: [T.y] Z: [T.z])</b><br>"
					menu += "Holder: <b>[ismob(L) ? L.name : "Error."]"
					if(L == usr)
						menu += "(Your implant)"
					menu += "</b><br>"
					menu += "********************************<br>"
				menu += "<b><i> Total Commander Implants: [implantnumber]</i></b><br>"
				menu += "<hr><br>"
				implantnumber = 0
				for(var/datum/extra_role/perseus/P in enforcers)
					var/mob/living/L = P.affecting.current
					var/turf/T = get_turf(L)
					var/area/A = get_area(T)
					if(!A || !T)
						continue
					implantnumber++
					menu += "Implant <b>[implantnumber]</b>: <br>"
					menu += "Area: <b>[A.name]</b><br>"
					menu += "Coordinates: <b>(X: [T.x] Y: [T.y] Z: [T.z])</b><br>"
					menu += "Holder: <b>[ismob(L) ? L.name : "Error."]"
					if(L == loc.loc)
						menu += " (Your implant)"
					menu += "</b><br>"
					menu += "********************************<br>"
				menu += "<b><i> Total Enforcer Implants: [implantnumber]</i></b><br>"
		return menu
	else
		return ..()



/*
* Soap
*/

/obj/item/soap/perseus
	desc = "An expensive bar of soap. Doesn't smell."
	icon = 'icons/oldschool/perseus.dmi'
	icon_state = "percsoap"

/*
* Medkit
*/

/obj/item/storage/firstaid/perseus
	name = "Perseus Medical Kit"
	desc = "An emergency first-aid kit for those feeling a little blue."
	icon = 'icons/oldschool/perseus.dmi'
	lefthand_file = 'icons/oldschool/perseus_inhand_left.dmi'
	righthand_file = 'icons/oldschool/perseus_inhand_right.dmi'
	icon_state = "percmedkit"
	PopulateContents()
		..()
		for(var/i=2,i>0,i--)
			new /obj/item/stimpack/perseus(src)
		new /obj/item/stack/medical/bruise_pack(src)
		new /obj/item/stack/medical/bruise_pack(src)
		new /obj/item/stack/medical/ointment(src)
		new /obj/item/storage/pill_bottle/charcoal(src)
		new /obj/item/healthanalyzer(src)